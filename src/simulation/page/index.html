<!DOCTYPE html>
<html>
    <head>
        <title>Test Broker</title>

        <style>

            body {
                background-color: black;
                color: white;
            }

            #actions button {
                width: 100px;
                height: 50px;
                color: white;
                font-size: 20px;
            }

            #callButton {
                background-color: green;
            }

            #putButton {
                background-color: red;
            }

        </style>

        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>

            var accountBalance = 0;
            var currentPrice = 0.0;
            var investment = 1000;
            var profitability = 0.7;
            var currentTimestamp;
            var openPositions = [];
            var dataPoint;

            function updateAccountBalance(newBalance) {
                accountBalance = newBalance;
                $('#accountBalance').text(newBalance);
            }

            function updateCurrentPrice(newPrice) {
                currentPrice = newPrice;
                $('#price').text(newPrice);
            }

            $(function() {
                // Show the initial account balance.
                updateAccountBalance(accountBalance);

                $('#callButton').on('click', function() {
                    updateAccountBalance(accountBalance - investment);
                });

                $('#putButton').on('click', function() {
                    updateAccountBalance(accountBalance - investment);
                });
            });

            var tradingSocket = new WebSocket('ws://localhost:8080');
            var dataSocket = new WebSocket('ws://0.0.0.0:8081');

            // Handle new data coming in.
            dataSocket.onmessage = function(event) {
                // Parse the incoming data.
                dataPoint = JSON.parse(event.data);

                // Close any positions that have expired.
                closeExpiredPositions(dataPoint.open, dataPoint.timestamp);

                updateCurrentPrice(dataPoint.open);
                $('#timestamp').text(new Date(dataPoint.timestamp));

                // Update the current timestamp.
                currentTimestamp = dataPoint.timestamp;

                // Forward the translated data to our server.
                tradingSocket.send(JSON.stringify(dataPoint));
            };

            // Handle instructions coming in from our server.
            tradingSocket.onmessage = function(event) {
                var message = JSON.parse(event.data);

                if (message.type === 'buy') {
                    // Set the investment amount.
                    $('#investment').val(investment);

                    if (message.direction === 'CALL') {
                        $('#callButton').click();
                    }
                    else if (message.direction === 'PUT') {
                        $('#putButton').click();
                    }

                    // Track the open position.
                    openPositions.push({
                        symbol: message.symbol,
                        direction: message.direction,
                        investment: investment,
                        price: dataPoint.close,
                        timestamp: currentTimestamp + (1000 * 59),
                        expirationTimestamp: currentTimestamp + (6 * 1000 * 60)
                    });
                }
            };

            function closeExpiredPositions(price, timestamp) {
                var openPositionsCopy = openPositions.slice();

                openPositionsCopy.forEach(function(position, index) {
                    var profitLoss = 0.0;

                    // Determine whether the position has expired.
                    if (timestamp >= position.expirationTimestamp + (5 * 60 * 1000)) {
                        if (position.direction === 'CALL') {
                            if (price > position.price) {
                                updateAccountBalance(accountBalance + position.investment + (profitability * position.investment));
                            }
                            else if (price === position.price) {
                                updateAccountBalance(accountBalance + position.investment);
                            }
                        }

                        if (position.direction === 'PUT') {
                            if (price < position.price) {
                                updateAccountBalance(accountBalance + position.investment + (profitability * position.investment));
                            }
                            else if (price === position.price) {
                                updateAccountBalance(accountBalance + position.investment);
                            }
                        }

                        // Remove the position from the list of open positions.
                        openPositions.splice(index, 1);
                    }
                });
            }

        </script>
    </head>
    <body>

        <h1>Account Balance: $<span id="accountBalance"></span></h2>

        <div id="actions">
            <button id="callButton">CALL</button>
            <button id="putButton">PUT</button>
        </div>

        <h3>Current price: $<span id="price"></span></h3>
        <h3>Current timestamp: <span id="timestamp"></span></h3>

        <div>
            <label>Investment:</label>
            <input id="investment" type="text" />
        </div>

    </body>
</html>
